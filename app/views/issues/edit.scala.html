@(id: Long, issueForm: Form[CriticalIssue], subdomains: List[Subdomain])

@import helper._

@main("Issue") {

<script type="text/javascript" language="javascript">

  // Declare global variable
  var assessment, canvas, numCircles = 1;

  $(document).ready(function() {
    // Get the canvas
     canvas = $("#assessmentCanvas")[0];
     var ctx = canvas.getContext('2d');

     // Setup random data
     var values = new Array();
      for (var i = 0; i < 4; i++) {
          var domainValues = new Array();
          for (var j = 0; j < 7; j++) {
            var extent = Math.ceil(Math.random() * numCircles);
            domainValues.push(extent);
          }
          values.push(domainValues);
      }

     // Create the Assessment
     assessment = new CoS.Assessment(ctx, { 
      width: 600, 
      height: 600,
      values:  values,
      numCircles: numCircles,
      drawText: true,
      axisLength: 1.2,
      lineWidth: 1,
      radiusProportion: 0.75,
      font: "bold 20px sans-serif",
      rotation: 0
     });

     assessment.drawAssessmentCircle();

      // Create the slider
      var currentVal = Math.ceil(numCircles / 2);
     $('#assessSlider').slider({ 
        min: 1, max: 12, value: Math.ceil(numCircles / 2), step: 1,
        slide: function(event, ui) {
          $("#slider-value").html(assessment.getRatingText(ui.value - 1));
        }
      });

     // Add colors to slider
     var colours = $(".scale-item");
     for (var i = 0; i < colours.length; i++) {
      var colourDiv = colours[i];
      $(colourDiv).css({'background-color': assessment.getRatingColor(i)});
     }

     // Event handling
     addHandler();
  });


  function addHandler() {
      canvas.addEventListener('click', function(e){
          var point = determinePoint(e);
          assessment.findSegment(point.x, point.y, updateSegment);
      });
      canvas.addEventListener('mousemove', function(e){
          var point = determinePoint(e);
          assessment.findSegment(point.x, point.y, showSubdomain);
      });
  }

  var determinePoint = function(e) {
      e = $.event.fix(e || window.event);
      return {x: e.offsetX, y: e.offsetY};
  }

  var updateSegment = function(domainId, domainName, subdomainId, subdomainName, oldValue, newValue) {
     drawSegment(domainId, domainName, subdomainId, subdomainName, oldValue, newValue);
     var mixedId =  (domainId) * 7 + subdomainId;
     // Trick to set the name of the hidden subdomain field
     $('#subdomain_' + mixedId).prop("disabled", false);
  }

  var showAssessmentDialog = function (domainId, domainName, subdomainId, subdomainName, oldValue, newValue) {
      $('#assessDomain').html(domainName);
      $('#assessSubdomain').html(subdomainName);
       $('#assessmentDialog').dialog({
           autoOpen: false,
           buttons: {
               "OK": function() {
                   var val = ($('#assessSlider').slider( "option", "value" ));
                   if (val > 9)
                      val = 9;
                   $(this).dialog('close');
                   drawSegment(domainId, domainName, subdomainId, subdomainName, oldValue, val);
               },
               "Cancel": function() {
                   $(this).dialog('close');
               }
           }
       });
      $('#assessSlider').slider({ min: 1, max: numCircles + 1, value: oldValue, step: 1 });
      $("#slider-value").html(assessment.getRatingText(oldValue - 1));

      $('#assessmentDialog').dialog('open');
  }

  var drawSegment = function drawSegment(domainId, domainName, subdomainId, subdomainName, oldValue, newValue, subdomainIndex) {
     // saveAssessment(extent);
     assessment.updateCircleSegment(domainId, subdomainId, newValue);
  }

  var showSubdomain = function showSubdomain(domainId, domainName, subdomainId, subdomainName, oldValue, newValue) {
    $("#tooltip").html(domainName + ": " + subdomainName);
  }

</script>

  <div id="page-heading">
    <ol class="breadcrumb">
      <li><a href="@routes.ProjectController.projects()">Project Listing</a></li>
      <li><a href="@routes.ProjectController.viewProject(issueForm.get().getProject().id)">Project Dashboard</a></li>
      <li class="active">New Issue</li>
    </ol>

    <h1>Add a new issue</h1>
  </div>
  <div class="container">
    <div class="panel panel-primary">
      <div class="panel-body">
        <div class="row text-left">
          @form(routes.IssueController.updateIssue(id)) {

          <div class="col-md-6">

                  @inputText(issueForm("name"), '_label -> "Issue Name", 'class -> "form-control")
                  
                  @textarea(issueForm("description"), '_label -> "Describe the issue", 'class -> "form-control")

                  <input type="submit" value="Save Issue" class="btn btn-primary">

                  <a href="@routes.ProjectController.viewProject(Long.valueOf(session.get("projectId")))" class="btn">Cancel</a> 

              <div>
                @for(indicator <- issueForm.get().getIndicators()) {
                    <a class="name" href="@routes.IndicatorController.editIndicator(issueForm.get().id, indicator.id)" class="btn-default">@indicator.getName()</a>
                }
              </div>
              <a href="@routes.IndicatorController.setupIndicator(issueForm.get().id)" class="btn">Add a new Indicator</a>


          </div>

          <div class="col-md-6">
            <div id="circles">
              <canvas id="assessmentCanvas" width="600" height="600" ></canvas>
            </div>

            <div>
            @for((subdomain, index) <- subdomains.zipWithIndex) {
              <input type="hidden" id="subdomain_@index" 
                name="subdomains[@index].id" 
                value="@subdomain.id" class="btn btn-primary"
                @if(!issueForm.get().getSubdomains().contains(subdomain)) {
                  disabled="disabled"
                } 
                >
              <script type="text/javascript">
                $(document).ready(function() {
                drawSegment(
                  Math.floor(@index / 7), 
                  '@subdomain.getParentDomain().getName()', 
                  (@index % 7) % 7, 
                  '@subdomain.getName()',
                  0,
                  @if(issueForm.get().getSubdomains().contains(subdomain)) {1} else {0}, 
                  @index
                );
                });
              </script>
            }
          </div>
          }


              @form(routes.IssueController.deleteIssue(id), 'class -> "topRight") {
                  <input type="submit" value="Delete this issue" class="btn danger">
              }


          </div>
        </div>
      </div>
    </div>
  </div>

}

